- name: Debug input version number
  debug:
    msg: "{{upgrade_version}}"

- name: Perform the selected upgrade
  command: oc adm upgrade --to="{{upgrade_version}}"
  when: upgrade | bool

- name: Make sure cluster starts the upgrade process
  k8s_info:
    api_version: v1
    kind: ClusterVersion
  register: reg_ocp_version
  vars:
    progressing_query: "resources[0].status.conditions[?type=='Progressing'].status"
    progressing: "{{ reg_ocp_version | json_query(progressing_query) | flatten | unique }}"
  when: upgrade | bool
  until:
    - reg_ocp_version.resources is defined
    - progressing == ['True']
  retries: 10 # wait for 5 minutes max
  delay: 30
